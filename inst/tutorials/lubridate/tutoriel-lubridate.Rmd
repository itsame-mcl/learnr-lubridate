---
title: "Tutorial lubridate"
output: learnr::tutorial
runtime: shiny_prerendered
description: "Tutoriel dédié à l'apprentissage des bases du package de gestion des dates : lubridate"
---

```{r setup, include=FALSE}
library(learnr)
knitr::opts_chunk$set(echo = FALSE)
```

## Introduction

Dans la plupart des logiciels et langages de programmation, le temps est considéré comme une simple valeur numérique à partir d'une date de référence.

Pour R, cette "origine des temps" est le 1er janvier 1970, 00:00:00 UTC. En revanche, LibreOffice Calc utilise le 30 décembre 1899 sous Windows et le 1er janvier 1904 sous macOS. Microsoft Excel utilise le 1er janvier 1900... ces différences d'origine complexifient le traitement des données temporelles.

Pour contourner ce problème, les indications temporelles sont souvent stockées sous un format textuel - par exemple "12/07/2014" - mais cela rend difficile la réalisation de calculs à partir de ces dates.

Les fonctionnalités de base de R permettent en partie de traiter ces questions, mais au prix de contraintes de syntaxe et d'un manque de souplesse.

Le package **lubridate** permet d'importer ou de générer des données temporelles, de réaliser des calculs de durées ou d'intervalles et d'accéder facilement aux différents éléments d'une date.

L'installation et le chargement s'effectuent à l'aide la commande suivante :

```{r installpack, message=FALSE, warning=FALSE, echo=TRUE}
#install.packages("lubridate")
library(lubridate)
```

## Importation de dates/heures

L'importation de données temporelles avec **lubridate** s'effectue en deux temps :

* Identification de l'ordre dans lequel les éléments apparaissent dans la donnée source : année (**y**), mois (**m**), jour (**d**), heure (**h**), minute (**m**), seconde (**s**).
* Appel de la fonction de **lubridate** reprenant l'ordre de ces éléments : 
  + **ymd_hms**() - Année Mois Jour Heure Minute Seconde -
  + **dmy**() - Jour Mois Année -
  + **dmy_hms**() - Jour Mois Année Heure Minute Seconde -
  + Toute autre combinaison avec **y**, **m**, **d**, **h**, **m** et **s**.
  
Les dates retournées par toutes les fonctions de **lubridate** sont au format "yyyy-mm-dd" (dd : day, mm : month, yyyy : year).
  
**Lubridate** posède également des fonctions **now**() et **today**() donnant respectivement la date du jour avec ou sans l'heure.

### Exemples

```{r, echo=TRUE}
date_1 <- ("25/12/2015") # Jour/Mois/Année
lubridate1 <- dmy(date_1)
lubridate1 # Notre date est bien importée au format yyyy-mm-dd

date_2 <- ("2020-24-12") # Année/Jour/Mois
lubridate2 <- ydm(date_2)
lubridate2

date_3 <- ("12 Janvier 2021 à 15:30:05") # Jour/Mois/Année/Heure/Minute/Seconde
lubridate3 <- dmy_hms(date_3)
lubridate3

now() # Date et heure actuelle
today() # Date actuelle seulement
```

### Exercices 

Pour chaque exercice, choisissez la fonction du package **lubridate** permettant l'import correct de la date. 

```{r dateimport1, exercise=TRUE, exercise.lines = 3}
date_1 <- ("13/01/2021")
lubridate1 <- # ICI code pour importer la date
lubridate1
```
```{r dateimport1-solution}
date_1 <- ("13/01/2021")
lubridate1 <- dmy(date_1)
lubridate1
```
```{r dateimport2, exercise=TRUE, exercise.lines = 3}
date_2 <- ("25-2021-10")
lubridate2 <- # ICI code pour importer la date
lubridate2
```
```{r dateimport2-solution}
date_2 <- ("25-2021-10")
lubridate2 <- dym(date_2)
lubridate2
```
```{r dateimport3, exercise=TRUE, exercise.lines = 3}
date_3 <- ("25 Février 2018 à 12H30")
lubridate3 <- # ICI code pour importer la date
lubridate3
```
```{r dateimport3-solution}
date_3 <- ("25 Février 2018 à 12H30")
lubridate3 <- dmy_hm(date_3)
lubridate3
```

```{r importquiz}
quiz(
  question("Quel est le format de date retourné par les fonctions lubridate ?",
    answer("yyyy-dd-mm"),
    answer("dd-mm-yyyy"),
    answer("yyyy-mm-dd", correct = TRUE),
    answer("dd-mm-yy"),
    allow_retry = TRUE
  )
)
```

## Conversion entre les fuseaux horaires

La liste des fuseaux horaires proposés par le package **lubridate** est disponible à l'aide de la fonction **OlsonNames()**.

L'équivalent d'une date/heure dans un autre fuseau horaire peut-être obtenu à l'aide de la fonction **with_tz**.

### Exemples

```{r, message=FALSE, warning=FALSE, echo=TRUE}
head(OlsonNames())
```

```{r, message=FALSE, warning=FALSE, echo=TRUE}
# Importation de la date (Cf. paragraphe précédent)
date <- dmy_hm("25 Février 2018 à 12H30")

# Conversion dans le fuseau horaire de Los Angeles
date_convertie <- with_tz(date, "America/Los_Angeles")
date_convertie

# Conversion dans le fuseau horaire de Abidjan
date_convertie2 <- with_tz(date, "Africa/Abidjan")
date_convertie2
```

### Exercices
Convertissez la date suivante dans le fuseau horaire de Asmera :
```{r dateconvert1, exercise=TRUE, exercise.lines = 3}
date_1 <- dmy_hm("25 Février 2018 à 12H30")
date_convertie_1 <- # ICI code pour convertir la date dans le fuseau horaire de Asmera
date_convertie_1
```
```{r dateconvert1-solution}
date_1 <- dmy_hm("25 Février 2018 à 12H30")
date_convertie_1 <- with_tz(date_1, "Africa/Asmera")
date_convertie_1
```
Convertissez maintenant la date dans le fuseau horaire de Los Angeles :
```{r dateconvert2, exercise=TRUE, exercise.lines = 3}
date_2 <- dmy_hm("25 Février 2018 à 12H30")
date_convertie_2 <- # ICI code pour convertir la date dans le fuseau horaire de Los Angeles
date_convertie_2
```
```{r dateconvert2-solution}
date_convertie_2 <- with_tz(date_2, "America/Los_Angeles")
date_convertie_2
```

## Manipulation des dates 

[Comment ajouter un fichier CSS !? ](https://education.rstudio.com/blog/2020/05/learnr-for-remote/#2-customized-hints-and-solutions)

Les dates sont des objets que l'on peut manipuler. Nous pouvons accèder aux différents éléments d'une date : année, mois, jour, heure, etc. Comme tout autre objet R, nous pouvons les modifier mais également faire des calculs.

### Accès aux éléments d'une date (Alanna)

Dans le package `lubridate` il existe de nombreuses fonctions pour accéder aux différents éléments d'une date.

Voici une liste non exhausive des élements d'une date que l'on peut extraire :

* `date` : date au format année-mois-jour
* `year` : année
* `month` : mois
* `semester` : numéro du semestre
* `quarter` : numéro du trimestre
* `week` : numéro de la semaine 
* `day` : jour du mois
* `wday` : jour de la semaine
* `qday` : jour du trimestre
* `hour` : heure
* `minute` : minute
* `second` : seconde
* `am` : est-ce le matin ?
* `pm` : est-ce l'après-midi ?
* `dst` : est-ce l'heure d'été ?
* `leap_year` : est-ce une année bisextile ?
* etc.

**Expliquer la syntaxe des fonctions ainsi que les sorties **

Il existe également quelques variantes pour permettre de mettre une date au format ISO comme `isoyear` ou `isomonth`.

**Parler de la fonction UPDATE ! et de `month(date + months(0:11), label = T, abbr = F)`**

Prenons un exemple que nous garderons dans toute la suite de cette partie comme le 1er septembre 1999 à 11h 59m 59s. Ici on affecte à la variable `date` la chaîne suivante : `01-09-1999 11:59:59` et la convertissons en date comme précédemment. 

#### Exemples

```{r date-1er-sept-99, echo=TRUE, include=TRUE, comment=''}
date <- dmy_hms("01-09-1999 11:59:59") # jour-mois-année convertit au format yyyy-mm-dd
date
day(date) # retourne le jour
am(date) # matin ?
pm(date) # après-midi ?
week(date) # retourne le numéro de la semaine
quarter(date, with_year = F) # trimestre
quarter(date, with_year = T) # trimestre
semester(date, with_year = F) # semestre
semester(date, with_year = T) # semestre
year(date) # retourne l'année
```


#### Exercices

Ecrire la date du 15 mai 1970 puis à l'aide d'une fonction extraire le mois (numéro et nom)
```{r 15-05-1970-month, exercise=TRUE, exercise.lines = 5}

```

```{r 15-05-1970-month-solution}
date <- dmy("15-05-1970")
month(date, label = T)
month(date, label = T, abbr = F)
```

**Afficher tous les mois de l'année à l'aide d'une commande --> expliquer un peu mieux + en parler plus haut dans le "cours"**
```{r months, exercise=TRUE, exercise.lines = 3}

```

```{r months-solution}
month(date + months(0:11), label = T, abbr = F)
```

Ennoncé
```{r day, exercise=TRUE, exercise.lines = 5}
date <- dmy("10-12-1990")
```

```{r day-solution}
day(date)
```


```{r quiz-compenents-date}
quiz(
  question("Question",
    answer("1"),
    answer("2"),
    answer("3", correct = TRUE),
    answer("4"),
    allow_retry = TRUE
  ),
  question("Parmi ces commandes, lequelles sont vraies?",
    answer("1", correct = TRUE),
    answer("2"),
    answer("3"),
    answer("4", correct = TRUE),
    allow_retry = TRUE
  )
)
```

### Modification d'une date (Alanna)


### Calculs avec des dates (Maxence)

## Horodatage (Maxence)
